<!doctype html><html lang=en><head><link rel=preconnect href=https://www.googletagmanager.com><link crossorigin rel=preconnect href=https://www.google-analytics.com><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-148413215-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><title>Rewriting ctrl-v using Next.js</title><meta name=description content="Ever since I released 


ctrl-v
, friends from HackClub have kept bugging me about switching my current React code over to use Next.js. I wanted to …"><link rel="shortcut icon" type=image/png href=/res/logo.png><meta name=viewport content="width=device-width,initial-scale=1"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&family=Source+Sans+Pro:wght@400;600&family=Fira+Code:wght@400;700&display=swap" rel=stylesheet><style>:root{--light: #faf8f8;--dark: #1e1e21;--navy: #284b63;--olive: #84a59d;--visited: #afbfc9;--salmon: #f28482;--gray: #4e4e4e;--lightgray: #f0f0f0;--outlinegray: #dadada;--lt-colours-light: var(--light) !important;--lt-colours-lightgray: var(--lightgray) !important;--lt-colours-dark: var(--navy) !important;--lt-colours-secondary: var(--olive) !important;--lt-colours-gray: var(--outlinegray) !important}h1,h2,h3,h4,ol,ul,thead{font-family:Inter;color:var(--dark)}p,li,text{font-family:source sans pro,sans-serif;color:var(--gray);fill:var(--gray)}pre{font-family:fira code;padding:.75em;border-radius:3px;overflow-x:scroll}code{font-family:fira code;font-size:.85em;padding:.15em .3em;border-radius:5px;background:var(--lightgray)}[saved-theme=dark]{--light: #1e1e21 !important;--dark: #fbfffe !important;--navy: #5b778a !important;--visited: #4a575e !important;--olive: #84a59d !important;--salmon: #f58382 !important;--gray: #d4d4d4 !important;--lightgray: #292633 !important;--outlinegray: #404040 !important}html{scroll-behavior:smooth;font-size:1.1em}body{margin:0;height:100vh;width:100vw;overflow-x:hidden;background-color:var(--light)}.hover{color:var(--dark);text-decoration:none;opacity:.6;z-index:1;transition:200ms}.hover::after{transition:200ms;height:18px;content:"";position:absolute;background-color:var(--olive);opacity:.5;z-index:-1;width:0%;right:5px;bottom:5px}.nodeLabel{background:rgba(255,255,255,.15);box-shadow:0 4px 15px 0 rgba(31,38,135,.12);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);border-radius:4px;border:1px solid rgba(255,255,255,.4)}.nodeLabel>p{margin:.25em .5em}@keyframes fadeIn{0%{opacity:0}100%{opacity:1}}footer{margin-top:4em}footer>a{font-family:inter;font-weight:700;font-size:1em;color:var(--navy);padding:0 .5em 3em}#newsletter{margin:2em 0}#newsletter>input{padding:.7em 1em;border-radius:4px}#newsletter>input[type=submit]{border:none;color:var(--light);background-color:var(--navy);cursor:pointer}#newsletter>input[type=email]{background-color:var(--light);border:1px solid var(--outlinegray);-webkit-box-sizing:border-box;-moz-box-sizing:border-box;-ms-box-sizing:border-box;box-sizing:border-box}hr{width:25%;margin:4em auto;height:2px;border-radius:1px;border-width:0;color:var(--dark);background-color:var(--dark)}a[href^="/"],a[href^="#"]{text-decoration:none;background-color:#afbfc922;padding:0 .2em;border-radius:3px}#contentWrapper,.singlePage{margin:25px 30vw}@media all and (max-width:1200px){#contentWrapper,.singlePage{margin:25px 5vw}}table{width:100%}article img{width:100%;border-radius:3px;margin:1em 0}p>img+em{display:block;transform:translateY(-1em)}#graph-container{border:var(--outlinegray)1px solid;border-radius:5px}</style><style>#TableOfContents>ol{counter-reset:section;margin-left:0;padding-left:1.5em}#TableOfContents>ol>li{counter-increment:section}#TableOfContents>ol>li>ol{counter-reset:subsection}#TableOfContents>ol>li>ol>li{counter-increment:subsection}#TableOfContents>ol>li>ol>li::marker{content:counter(section)"." counter(subsection)"  "}#TableOfContents>ol>li::marker{content:counter(section)"  "}#TableOfContents>ol>li::marker,#TableOfContents>ol>li>ol>li::marker{font-family:Source Sans Pro;font-weight:700}.postLi{margin-bottom:1em}.postLi>.time{margin:0;margin-bottom:-1em!important;font-family:fira code;font-weight:400;font-size:.5em}.singlePost{display:flex;flex-direction:row;align-items:center;justify-content:space-between}.singlePost *{margin:.1em auto}.singlePost>.desc{flex:1}.singlePost>.desc>*{display:inline-block}header{display:flex;flex-direction:row;align-items:center;justify-content:space-between}nav>a{margin-left:2em}footer{margin-top:4em;text-align:center}.meta{margin-left:2em!important}@media all and (max-width:600px){header>nav{display:none}}sup{line-height:0}.morePosts{min-height:3em}.postLink{display:inline-block}.postLink.next{float:right}</style><style>a{font-family:Inter;font-weight:700;text-decoration:none;transition:all .2s ease;color:var(--navy)}a:hover{color:var(--olive)!important}.postLink:visited{color:var(--visited)}#posts{list-style:none;padding:0;margin:0}p,tbody,article li{font-family:Source Sans Pro;color:var(--gray);line-height:1.5em}input{font-family:Source Sans Pro;color:var(--gray)}h2{opacity:.85}h3{opacity:.75}blockquote{margin-left:0;border-left:3px solid var(--navy);padding-left:1em;transition:border-color .2s ease}blockquote:hover{border-color:var(--olive)}table{padding:1.5em}td,th{padding:.1em .5em}.footnotes p{margin:.5em 0}article a{font-family:Source Sans Pro;font-weight:600;text-decoration:underline;text-decoration-color:var(--olive);text-decoration-thickness:.15em}sup>a{text-decoration:none;padding:0 .1em 0 .2em}</style><style>.chroma{color:#f8f8f2;background-color:#282a36}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .ln{margin-right:.4em;padding:0 .4em;color:#7f7f7f}.chroma .k{color:#ff79c6}.chroma .kc{color:#ff79c6}.chroma .kd{color:#8be9fd;font-style:italic}.chroma .kn{color:#ff79c6}.chroma .kp{color:#ff79c6}.chroma .kr{color:#ff79c6}.chroma .kt{color:#8be9fd}.chroma .na{color:#50fa7b}.chroma .nb{color:#8be9fd;font-style:italic}.chroma .nc{color:#50fa7b}.chroma .nf{color:#50fa7b}.chroma .nl{color:#8be9fd;font-style:italic}.chroma .nt{color:#ff79c6}.chroma .nv{color:#8be9fd;font-style:italic}.chroma .vc{color:#8be9fd;font-style:italic}.chroma .vg{color:#8be9fd;font-style:italic}.chroma .vi{color:#8be9fd;font-style:italic}.chroma .s{color:#f1fa8c}.chroma .sa{color:#f1fa8c}.chroma .sb{color:#f1fa8c}.chroma .sc{color:#f1fa8c}.chroma .dl{color:#f1fa8c}.chroma .sd{color:#f1fa8c}.chroma .s2{color:#f1fa8c}.chroma .se{color:#f1fa8c}.chroma .sh{color:#f1fa8c}.chroma .si{color:#f1fa8c}.chroma .sx{color:#f1fa8c}.chroma .sr{color:#f1fa8c}.chroma .s1{color:#f1fa8c}.chroma .ss{color:#f1fa8c}.chroma .m{color:#bd93f9}.chroma .mb{color:#bd93f9}.chroma .mf{color:#bd93f9}.chroma .mh{color:#bd93f9}.chroma .mi{color:#bd93f9}.chroma .il{color:#bd93f9}.chroma .mo{color:#bd93f9}.chroma .o{color:#ff79c6}.chroma .ow{color:#ff79c6}.chroma .c{color:#6272a4}.chroma .ch{color:#6272a4}.chroma .cm{color:#6272a4}.chroma .c1{color:#6272a4}.chroma .cs{color:#6272a4}.chroma .cp{color:#ff79c6}.chroma .cpf{color:#ff79c6}.chroma .gd{color:#8b080b}.chroma .ge{text-decoration:underline}.chroma .gh{font-weight:700}.chroma .gi{font-weight:700}.chroma .go{color:#44475a}.chroma .gu{font-weight:700}.chroma .gl{text-decoration:underline}.lntd:first-of-type>.chroma{padding-right:0}.chroma code{font-family:fira code!important;font-size:.85em;line-height:1em;background:0 0;padding:0}.chroma{border-radius:3px;margin:0}</style><style>.darkmode{text-align:right}.darkmode>.toggle{display:none;box-sizing:border-box}.darkmode>.toggle:checked+.toggle-button:after{left:50%}.darkmode>.toggle+.toggle-button{box-sizing:border-box;outline:0;display:inline-block;width:3em;height:1.5em;position:relative;cursor:pointer;border:2px solid var(--gray);user-select:none;padding:2px;transition:all .2s ease;border-radius:2em}.darkmode>.toggle+.toggle-button:after,.darkmode>.toggle+.toggle-button:before{position:relative;display:block;box-sizing:border-box;content:"";width:50%;height:100%}.darkmode>.toggle+.toggle-button:before{display:none}.darkmode>.toggle+.toggle-button:after{left:0;transition:all .2s ease;background:var(--gray);content:"";border-radius:1em}.darkmode #dayIcon{position:relative;width:20px;height:20px;top:-1.5px;margin:0 7px;fill:var(--gray)}.darkmode #nightIcon{position:relative;width:18px;height:18px;top:-2px;margin:0 7px;fill:var(--gray)}</style></head><body><div id=contentWrapper><header><h1><a href=/posts>jzhao.xyz</a></h1><div class=darkmode><label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06L6.439 8.561zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label class=toggle-button for=darkmode-toggle></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><div id=postTitle class=desc><h1>Rewriting ctrl-v using Next.js</h1><p>written April 11, 2021 // 10 min read</p></div><aside class=mainTOC><h3>Table of Contents</h3><nav id=TableOfContents><ol><li><a href=#learning-nextjs>Learning Next.js</a></li><li><a href=#why-nextjs>Why Next.js</a></li><li><a href=#steps>Steps</a><ol><li><a href=#replacing-react-router-with-nextrouter>Replacing React Router with <code>next/router</code></a></li><li><a href=#styled-components-and-theme-provider><code>styled-components</code> and theme provider</a></li><li><a href=#state-caching-for-password-pastes>State caching for password pastes</a></li><li><a href=#deployment>Deployment</a></li></ol></li><li><a href=#impact>Impact</a></li></ol></nav></aside><div id=mainText><p><img src=/posts/images/ctrlv-next/title.png alt="Rewriting ctrl-v using Next.js"></p><p>Ever since I released
<a href=https://github.com/jackyzha0/ctrl-v/ rel=noopener>ctrl-v</a>
, friends from HackClub have kept bugging me about switching my current React code over to use Next.js. I wanted to see what all the fuss was about, so I finally set aside some time this weekend to rewrite the frontend using Next.js and deployed it on Vercel instead of Firebase Hosting. I thought it would take the whole weekend, but I managed to go from zero knowledge about Next.js to a fully finished refactor in just under 6 hours!</p><p>This will be more of a technical blog post walking through my process in converting ctrl-v from using React Router and Firebase Hosting to Next.js and Firebase.</p><p>Source code: <a href=https://github.com/jackyzha0/ctrl-v>https://github.com/jackyzha0/ctrl-v</a></p><h2 id=learning-nextjs>Learning Next.js</h2><p>I&rsquo;m a very hands-on learner. I learn the fastest stumbling my way through a project with a framework I barely know my way around than watching multiple video examples or reading blog posts. Having a tangible project to work with and break as I learned things really helped speed up the learning process for me. That being said, here are a few other resources I found really helpful in my journey!</p><ul><li><a href="https://www.youtube.com/watch?v=Sklc_fQBmcs" rel=noopener>Next.js in 100 seconds + good beginner tutorial</a></li><li><a href=https://nextjs.org/docs/api-reference/create-next-app rel=noopener>Twiddling around with <code>create-next-app</code></a></li><li><a href=https://nextjs.org/docs/migrating/from-react-router rel=noopener>Next.js official documentation for migrating from React Router</a></li></ul><h2 id=why-nextjs>Why Next.js</h2><p>The main reason I wanted to switch to Next.js is because it makes it dead easy to implement both Static Site Generation (SSG) and Server Side Rendering (SSR) for your React app. For those uninitiated, SSR and SSG are different approaches to rendering content.</p><p>In <strong>Client Side Rendering (CSR)</strong>, the client is responsible for rendering the content on the page. All they receive is an empty HTML document, and a bunch of JavaScript bundles through which the browser populates the page. The downside of this approach is that no content exists on the page when it is first loaded. As a result, web crawlers won&rsquo;t be able to find your content (not great for SEO), and you won&rsquo;t get link previews to your content as the page metadata won&rsquo;t have loaded. This is the behaviour you get when you use plain old React.</p><p>In <strong>Server Side Rendering (SSR)</strong>, the server is responsible for rendering the content of the page and sending the fully rendered the content to the user to display. In this approach, all the content is already loaded when the user is receives it, we only need JavaScript to make it interactable (i.e. hydrate it). As a result, this approach is a lot more SEO friendly.</p><p>On the very other end of the spectrum, <strong>Static Site Generation (SSG)</strong>, means that the server does all of the page rendering at <em>build time</em> rather than on each request. This has all the same benefits as SSR but doesn&rsquo;t really make a lot of sense for this project as I don&rsquo;t have a full list of pages I need to render handy.</p><p><strong>A hybrid approach</strong></p><p>However, Next.js doesn&rsquo;t force you to choose between the two. It actually prides itself in just how easy they make it to switch between them. Here&rsquo;s the approach I decided to take for ctrl-v.</p><p>In the old frontend, everything was completely client-side rendered. My &lsquo;productionized&rsquo; application was quite literally an <code>index.html</code> with a bunch of JS bundles. It sucked as whenever I sent a ctrl-v link to a friend, there wouldn&rsquo;t be a preview about what the content was and most people were scared to just open a random link like that (rightfully so). There was also a not-very-pleasant &lsquo;loading paste&mldr;&rsquo; period before any content actually appeared on the screen.</p><p><img src=/posts/images/ctrlv-next/rendering.png alt="Old vs new approaches to rendering content"></p><p>I realized that there were only really two main types of pages</p><ol><li>View Paste (<code>/:paste</code>)</li><li>Create Paste (<code>/</code>)</li></ol><p>Nothing on the create paste page actually required hitting the backend, it was effectively completely static. I could safely just replace that entire page and have it be statically generated at build time. The view paste page required me to make a call to ctrl-v&rsquo;s backend API but I still wanted the page to have that content rendered on server so I opted for client side rendering on any view paste pages.</p><h2 id=steps>Steps</h2><h3 id=replacing-react-router-with-nextrouter>Replacing React Router with <code>next/router</code></h3><p>Next.js uses a file-based routing system rather than routes-as-code approach that React Router takes. I decided to first convert the new paste page as that would be completely SSG. Luckily, I had originally structured my React components into a <code>pages</code> folder so pulling out that component into a page wasn&rsquo;t terrible.</p><p>I wasn&rsquo;t super certain of how SSR worked right off the bat so I first played with the <code>/raw/:paste</code> page first before tackling the comparatively more scary <code>/:paste</code> page with password handling and actual error handling.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-jsx data-lang=jsx><span class=c1>// old CSR
</span><span class=c1></span><span class=kr>const</span> <span class=nx>Raw</span> <span class=o>=</span> <span class=p>({</span><span class=nx>hash</span><span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
   <span class=kr>const</span> <span class=p>{</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>result</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useFetchPaste</span><span class=p>(</span><span class=nx>hash</span><span class=p>)</span>
   <span class=k>return</span> <span class=p>&lt;</span><span class=nt>RawText</span><span class=p>&gt;{</span><span class=nx>result</span><span class=o>?</span><span class=p>.</span><span class=nx>content</span> <span class=o>||</span> <span class=nx>err</span><span class=p>}&lt;/</span><span class=nt>RawText</span><span class=p>&gt;</span>
<span class=p>}</span>

<span class=kr>export</span> <span class=k>default</span> <span class=nx>Raw</span>

<span class=c1>// new SSR
</span><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getServerSideProps</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// ctx.params.hash allows us to access the slug (the :paste part of the url)
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>resolvePaste</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>hash</span><span class=p>)</span>
  <span class=k>return</span> <span class=p>{</span> <span class=nx>props</span><span class=o>:</span> <span class=p>{</span> <span class=p>...</span><span class=nx>data</span> <span class=p>}</span> <span class=p>}</span>
<span class=p>}</span>

<span class=kr>const</span> <span class=nx>Raw</span> <span class=o>=</span> <span class=p>({</span><span class=nx>error</span><span class=p>,</span> <span class=nx>data</span><span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
    <span class=p>{</span><span class=cm>/* Only load title/description metadata if no error */</span><span class=p>}</span>
    <span class=p>{</span><span class=o>!</span><span class=nx>error</span> <span class=o>&amp;&amp;</span> <span class=p>&lt;</span><span class=nt>NextHead</span> <span class=na>data</span><span class=o>=</span><span class=p>{</span><span class=nx>data</span><span class=p>}</span> <span class=p>/&gt;}</span>
    <span class=p>&lt;</span><span class=nt>RawText</span><span class=p>&gt;</span>
      <span class=p>{</span><span class=cm>/* Just render the content if it exists, otherwise render the errror */</span><span class=p>}</span>
      <span class=p>{</span><span class=nx>data</span><span class=o>?</span><span class=p>.</span><span class=nx>content</span> <span class=o>||</span> <span class=nx>error</span><span class=p>}</span>
    <span class=p>&lt;/</span><span class=nt>RawText</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
<span class=p>}</span>

<span class=kr>export</span> <span class=k>default</span> <span class=nx>Raw</span>
</code></pre></td></tr></table></div></div><p>The biggest part I needed to wrap my head around was the <code>getServerSideProps</code> async function. I didn&rsquo;t realize that the only job that <code>getServerSideProps</code> actually does, is fetch data and pass that data as props to your actual component. Once that clicked, the rest of the refactoring went relatively smoothly.</p><p>I had to refactor my <code>useFetchPaste</code> hook to just fetch data and then delegated the responsibility of state and password validation shenanigans to whatever component. I ended up changing the name to <code>resolvePaste</code> as it no longer followed the
<a href=https://reactjs.org/docs/hooks-rules.html rel=noopener>Rules of Hooks</a>
.</p><p>In hindsight, I probably should&rsquo;ve done this step incrementally using something like
<a href=https://nextjs.org/docs/api-reference/next.config.js/rewrites rel=noopener>Next.js&rsquo;s rewrite rules</a>
to gradually transition ctrl-v from React Router to Next.js. Luckily I didn&rsquo;t have that many pages to migrate but this is good to know for the future.</p><h3 id=styled-components-and-theme-provider><code>styled-components</code> and theme provider</h3><p>From what I&rsquo;ve seen, Next.js doesn&rsquo;t play nicely with <code>styled-components</code> out of the box. Throughout the entire previous step, I was looking at painfully broken CSS. Turns out you need to
<a href=https://styled-components.com/docs/tooling#babel-plugin rel=noopener>install an additional Babel plugin</a>
to add SSR support to <code>styled-components</code>. Then, I added a custom <code>Document</code> to <code>pages/_document.js</code>. This code augments the root <code>&lt;html></code> tag of our application which will allow us to inline our CSS styles.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-jsx data-lang=jsx><span class=c1>// shamelessly stolen from
</span><span class=c1>// https://github.com/vercel/next.js/blob/master/examples/with-styled-components/pages/_document.js
</span><span class=c1></span><span class=kr>import</span> <span class=nx>Document</span> <span class=nx>from</span> <span class=s1>&#39;next/document&#39;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>ServerStyleSheet</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;styled-components&#39;</span>

<span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>StyledDocument</span> <span class=kr>extends</span> <span class=nx>Document</span> <span class=p>{</span>
  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>getInitialProps</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=nx>sheet</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ServerStyleSheet</span><span class=p>()</span>
    <span class=kr>const</span> <span class=nx>originalRenderPage</span> <span class=o>=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>renderPage</span>

    <span class=k>try</span> <span class=p>{</span>
      <span class=nx>ctx</span><span class=p>.</span><span class=nx>renderPage</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span>
        <span class=nx>originalRenderPage</span><span class=p>({</span>
          <span class=nx>enhanceApp</span><span class=o>:</span> <span class=p>(</span><span class=nx>App</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>=&gt;</span>
            <span class=nx>sheet</span><span class=p>.</span><span class=nx>collectStyles</span><span class=p>(&lt;</span><span class=nt>App</span> <span class=p>{</span><span class=na>...props</span><span class=p>}</span> <span class=p>/&gt;),</span>
        <span class=p>})</span>

      <span class=kr>const</span> <span class=nx>initialProps</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Document</span><span class=p>.</span><span class=nx>getInitialProps</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
      <span class=k>return</span> <span class=p>{</span>
        <span class=p>...</span><span class=nx>initialProps</span><span class=p>,</span>
        <span class=nx>styles</span><span class=o>:</span> <span class=p>(</span>
          <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
            <span class=p>{</span><span class=nx>initialProps</span><span class=p>.</span><span class=nx>styles</span><span class=p>}</span>
            <span class=p>{</span><span class=nx>sheet</span><span class=p>.</span><span class=nx>getStyleElement</span><span class=p>()}</span>
          <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
        <span class=p>),</span>
      <span class=p>}</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=nx>sheet</span><span class=p>.</span><span class=nx>seal</span><span class=p>()</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>As I was also using theme provider from <code>styled-components</code>, I needed a way to wrap the ThemeProvider component around everything. Luckily a custom <code>App</code> created by adding a <code>pages/_app.js</code> will allow us to do just that. This also allows us to add any &lsquo;global&rsquo; structure like padding or margins around the edges.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-jsx data-lang=jsx><span class=kr>import</span> <span class=nx>ThemeProvider</span> <span class=nx>from</span> <span class=s2>&#34;../theme/ThemeProvider&#34;</span><span class=p>;</span>
<span class=kr>import</span> <span class=nx>GlobalStyle</span> <span class=nx>from</span> <span class=s2>&#34;../theme/GlobalStyle&#34;</span><span class=p>;</span>

<span class=kr>const</span> <span class=nx>Main</span> <span class=o>=</span> <span class=nx>styled</span><span class=p>.</span><span class=nx>div</span><span class=sb>`
</span><span class=sb>  margin-top: 10vh;
</span><span class=sb>  padding: 0 20vw 30px 20vw;
</span><span class=sb>`</span>

<span class=kr>const</span> <span class=nx>App</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>Component</span><span class=p>,</span> <span class=nx>pageProps</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>(</span>
  <span class=p>&lt;</span><span class=nt>ThemeProvider</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>GlobalStyle</span> <span class=p>/&gt;</span>
    <span class=p>&lt;</span><span class=nt>Head</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span><span class=nx>ctrl</span><span class=o>-</span><span class=nx>v</span> <span class=o>|</span> <span class=nx>a</span> <span class=nx>modern</span><span class=p>,</span> <span class=nx>open</span><span class=o>-</span><span class=nx>source</span> <span class=nx>pastebin</span><span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
    <span class=p>&lt;/</span><span class=nt>Head</span><span class=p>&gt;</span>
    <span class=p>&lt;</span><span class=nt>Main</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;appElement&#34;</span><span class=p>&gt;</span>
      <span class=p>&lt;</span><span class=nt>Component</span> <span class=p>{</span><span class=na>...pageProps</span><span class=p>}</span> <span class=p>/&gt;</span>
    <span class=p>&lt;/</span><span class=nt>Main</span><span class=p>&gt;</span>
  <span class=p>&lt;/</span><span class=nt>ThemeProvider</span><span class=p>&gt;</span>
<span class=p>)</span>

<span class=kr>export</span> <span class=k>default</span> <span class=nx>App</span>
</code></pre></td></tr></table></div></div><h3 id=state-caching-for-password-pastes>State caching for password pastes</h3><p>This part stumped me for a good bit. I needed to find a way to do an initial data fetch, check to see if the paste has a password, prompt the user for a password, then reload the page data. I contemplated using
<a href=https://swr.vercel.app/ rel=noopener>SWR</a>
for data fetching but realized in the shower that it wouldn&rsquo;t really make sense as the initial load is handled in the <code>getServerSideProps</code> function anyways. I realized the best way forward was to fetch the initial state in <code>getServerSideProps</code> then store it as a React State so I can update it when a password is entered and data is re-fetched. This way there are no page reloads to disrupt user experience and keeps code change minimal.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-jsx data-lang=jsx><span class=c1>// simplified version of pages/[hash].js
</span><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getServerSideProps</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span> <span class=p>{</span>
  <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>resolvePaste</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>hash</span><span class=p>)</span>
  <span class=k>return</span> <span class=p>{</span> <span class=nx>props</span><span class=o>:</span> <span class=p>{</span> <span class=p>...</span><span class=nx>data</span> <span class=p>}</span> <span class=p>}</span>
<span class=p>}</span>

<span class=kr>const</span> <span class=nx>ViewPaste</span> <span class=o>=</span> <span class=p>({</span><span class=nx>data</span><span class=p>,</span> <span class=nx>unauthorized</span><span class=p>,</span> <span class=nx>error</span><span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
  <span class=kr>const</span> <span class=p>{</span> <span class=nx>hash</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>query</span> <span class=c1>// equivalent to ctx.params.hash
</span><span class=c1></span>  <span class=kr>const</span> <span class=p>[</span><span class=nx>enteredPass</span><span class=p>,</span> <span class=nx>setEnteredPass</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>);</span>
  <span class=kr>const</span> <span class=p>[</span><span class=nx>correctPass</span><span class=p>,</span> <span class=nx>setCorrectPass</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=o>!</span><span class=nx>unauthorized</span><span class=p>);</span>
  <span class=kr>const</span> <span class=p>[</span><span class=nx>clientData</span><span class=p>,</span> <span class=nx>setClientData</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
  <span class=kr>const</span> <span class=p>{</span><span class=nx>content</span><span class=p>,</span> <span class=nx>language</span><span class=p>,</span> <span class=nx>expiry</span><span class=p>,</span> <span class=nx>title</span><span class=p>}</span> <span class=o>=</span> <span class=nx>clientData</span><span class=p>;</span>

  <span class=kr>const</span> <span class=nx>getWithPassword</span> <span class=o>=</span> <span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>errorCallback</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
    <span class=nx>resolvePaste</span><span class=p>(</span><span class=nx>hash</span><span class=p>,</span> <span class=nx>password</span><span class=p>)</span>
      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>resp</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=nx>setCorrectPass</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
        <span class=nx>setClientData</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
      <span class=p>})</span>
      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>e</span> <span class=p>=&gt;</span> <span class=nx>errorCallback</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>))</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=p>(</span>
    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
      <span class=p>{</span><span class=o>!</span><span class=nx>error</span> <span class=o>&amp;&amp;</span> <span class=p>&lt;</span><span class=nt>NextHead</span> <span class=na>data</span><span class=o>=</span><span class=p>{</span><span class=nx>data</span><span class=p>}</span> <span class=p>/&gt;}</span>
      <span class=p>...</span>
      <span class=p>&lt;</span><span class=nt>PasteInfo</span>
        <span class=na>hash</span><span class=o>=</span><span class=p>{</span><span class=nx>hash</span><span class=p>}</span>
        <span class=na>lang</span><span class=o>=</span><span class=p>{</span><span class=nx>language</span><span class=p>}</span>
        <span class=na>theme</span><span class=o>=</span><span class=p>{</span><span class=nx>theme</span><span class=p>}</span>
        <span class=na>expiry</span><span class=o>=</span><span class=p>{</span><span class=nx>expiry</span><span class=p>}</span>
        <span class=na>err</span><span class=o>=</span><span class=p>{</span><span class=nx>unauthorized</span> <span class=o>?</span> <span class=s1>&#39;&#39;</span> <span class=o>:</span> <span class=nx>error</span><span class=p>}</span>
      <span class=p>/&gt;</span>
    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
  <span class=p>);</span>
<span class=p>}</span>

<span class=kr>export</span> <span class=k>default</span> <span class=nx>ViewPaste</span>
</code></pre></td></tr></table></div></div><h3 id=deployment>Deployment</h3><p>Great! At this point, everything was working great &ndash; locally. Every developer knows just how much of a leap it is to go from local machine to hosted and on the cloud. Right?</p><p>My first thought was to see how difficult it would be to port my existing frontend on Firebase Hosting to run using Next.js instead. Turns out I would&rsquo;ve needed to enable Firebase Functions and to do that I needed to enable the Blaze plan (pay as you go). Seeing just
<a href=https://dev.to/rowaxl/what-i-struggled-with-next-js-using-firebase-hosting-and-enable-ssr-4e67 rel=noopener>how much of a hassle the process was</a>
made me look for other alternatives.</p><p>Vercel really surprised me with how easy it was to get setup. All I had to do was signup for Vercel using my GitHub account and select a repository to import. It took a total of 5 minutes to go from GitHub repo to deployed website which was a first.</p><p>Funnily enough, the hardest part of this entire deployment process was deleting the old frontend off of Firebase. I accidentally deleted the entire project (including my Cloud Run deployed backend) twice and quite nearly misconfigured my domain.</p><h2 id=impact>Impact</h2><p>All in all, trading 6 hours for such a huge quality-of-life improvement on a project that I personally use a lot has been absolutely worth it. To list a few tangible improvements:</p><ul><li>Smoother user experience (no more annoying &lsquo;loading paste&mldr;&rsquo; messages)</li><li>Cleaner codebase</li><li>Better link previews (sending links to friends)</li></ul><p>If you haven&rsquo;t had the chance to try Next.js out for yourself and you&rsquo;ve made it this far, you owe it to yourself to at least give it a shot. Thanks to the HackClub community (specifically
<a href=https://rishi.cx/ rel=noopener>Rishi</a>
,
<a href=https://safin.dev/ rel=noopener>Safin</a>
, and
<a href=https://anirudhb.github.io/ rel=noopener>Ani</a>
) for their constant encouragement and criticism of my &lsquo;outdated&rsquo; tech stack.</p><p><strong>Source Code</strong>: <a href=https://github.com/jackyzha0/ctrl-v>https://github.com/jackyzha0/ctrl-v</a></p><p><strong>Try it out for yourself</strong>: <a href=https://ctrl-v.app/>https://ctrl-v.app/</a></p></div><div><hr><div class=morePosts><a class=postLink href="https://jzhao.xyz/posts/framing/?ref=footer">← Framing and Context Collapse</a>
<a class="postLink next" href="https://jzhao.xyz/posts/paid-open-source/?ref=footer">A case for funding Open Source →</a></div><article><p>I'm always happy to have follow up conversations or hear your thoughts! Shoot me an email at <a href=mailto:j.zhao2k19@gmail.com>j.zhao2k19@gmail.com</a> or <a href=https://twitter.com/_jzhao>yell at me on Twitter</a>.</p><p>If you like this content and want to keep up to
date with my latest ramblings and whatever else I've found interesting on the web, you should consider subscribing to my
newsletter :) Not convinced yet? Read some <a href=/newsletters>previous issues here</a>!</p><form id=newsletter action=https://buttondown.email/api/emails/embed-subscribe/jacky method=post target=popupwindow onsubmit="window.open('https://buttondown.email/jacky','popupwindow')" class=embeddable-buttondown-form><input type=email placeholder=name@email.com name=email id=bd-email>
<input type=hidden value=1 name=embed>
<input type=submit value=Subscribe></form></article><a href=/posts>← (country roads) take me home</a></div></article><footer><footer><p>made by Jacky Zhao, © 2021</p><a href=/>home</a>
<a href=https://github.com/jackyzha0/jackyzha0.github.io>source</a><a href=https://twitter.com/_jzhao>twitter</a></footer></footer></div><script>const userPref=window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'
const currentTheme=localStorage.getItem('theme')??userPref
if(currentTheme){document.documentElement.setAttribute('saved-theme',currentTheme);}
const switchTheme=(e)=>{if(e.target.checked){document.documentElement.setAttribute('saved-theme','dark')
localStorage.setItem('theme','dark')}
else{document.documentElement.setAttribute('saved-theme','light')
localStorage.setItem('theme','light')}}
window.addEventListener('DOMContentLoaded',()=>{const toggleSwitch=document.querySelector('#darkmode-toggle')
toggleSwitch.addEventListener('change',switchTheme,false)
if(currentTheme==='dark'){toggleSwitch.checked=true}})</script></body></html>